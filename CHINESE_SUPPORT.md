# 汉字显示功能说明

## 概述

LCD位图编辑器现已支持汉字显示功能，可以在屏幕上绘制中文字符和ASCII字符的混合文本。

## 实现的功能

### 1. GB2312编码支持
- 自动将Unicode字符转换为GB2312编码
- 支持7445个GB2312字符的映射
- 支持ASCII字符在GB2312中的全角表示

### 2. 汉字字库支持
支持以下汉字字库：
- **HZK12** (12x12像素)
- **HZK16** (16x16像素) - 推荐
- **HZK24** (24x24像素)
- **HZK32** (32x32像素)
- **HZK40** (40x40像素)
- **HZK48** (48x48像素)

### 3. 混合文本渲染
- 自动识别ASCII字符和汉字
- ASCII字符可以使用ASCII字库或汉字库绘制
- 汉字使用汉字库绘制
- 支持反显模式

## 使用方法

### 基本使用

1. **选择ASCII字库**
   - 在"ASCII字库"下拉框中选择要使用的字体
   - 或选择"使用汉字库"选项，使用汉字库中的ASCII字符

2. **选择汉字库**
   - 在"汉字库"下拉框中选择要使用的汉字字库
   - 推荐使用HZK16 (16x16)

3. **输入文本**
   - 在文本输入框中输入要显示的文本
   - 支持中英文混合输入
   - 例如："你好World123"

4. **设置位置**
   - 设置X和Y坐标，指定文本的起始位置

5. **绘制文本**
   - 点击"放置文本"按钮
   - 文本将自动绘制到画布上

### 高级用法

#### 使用汉字库中的ASCII字符

1. 将"ASCII字库"设置为"使用汉字库"
2. 选择一个汉字库（如HZK16）
3. 输入ASCII文本（如"ABC123"）
4. ASCII字符将以全角形式显示（每个字符占用汉字的宽度）

#### 混合ASCII和汉字

1. 选择一个ASCII字库（如"8x16 字体"）
2. 选择一个汉字库（如"HZK16"）
3. 输入混合文本（如"CPU温度:45℃"）
4. ASCII字符使用8x16字体，汉字使用16x16字体

## 技术细节

### GB2312编码规则

#### ASCII字符
- ASCII字符在GB2312中的位置：`0xA3, 0xA0 + (code - 0x20)`
- 例如：
  - 空格(0x20) -> [0xA3, 0xA0]
  - 'A'(0x41) -> [0xA3, 0xC1]
  - '1'(0x31) -> [0xA3, 0xB1]

#### 汉字
- 使用预生成的Unicode到GB2312映射表
- 映射表位置：`fonts/gb2312_unicode_map.json`
- 例如：
  - '中'(U+4E2D) -> [0xD6, 0xD0]
  - '国'(U+56FD) -> [0xB9, 0xFA]

### 字库偏移计算

#### 标准字库 (HZK12, HZK16, HZK24, HZK32)
```javascript
offset = (94 * (qu - 1) + (wei - 1)) * bytesPerChar
其中: qu = t1 - 0xA0, wei = t2 - 0xA0
```

#### 大字库 (HZK40, HZK48)
```javascript
offset = ((t1 - 0xA1 - 0x0F) * 94 + (t2 - 0xA1)) * bytesPerChar
注意: 这两个字库跳过了前15个区
```

### 字模数据格式
- 按行存储，每行从高位到低位
- 每8个像素占用1个字节
- 不足8个像素的行，剩余位补0

## 文件说明

### 新增文件
1. **gb2312_encoder.js** - GB2312编码转换模块
2. **hzk_fonts.js** - 汉字字库处理模块
3. **fonts/gb2312_unicode_map.json** - Unicode到GB2312映射表
4. **generate_gb2312_map.py** - 映射表生成脚本
5. **test_chinese.html** - 功能测试页面

### 修改文件
1. **index.html** - 添加汉字支持功能

## 测试

### 使用测试页面
打开 `test_chinese.html` 进行功能测试：

1. **GB2312编码器测试** - 验证字符编码是否正确
2. **汉字字库加载测试** - 验证字库文件是否正确加载
3. **字符提取测试** - 验证字模数据是否正确提取

### 手动测试
在主编辑器(`index.html`)中：

1. 测试纯ASCII文本：`Hello World 123`
2. 测试纯汉字文本：`你好世界`
3. 测试混合文本：`温度Temperature: 25℃`
4. 测试反显模式：勾选"反显"复选框后绘制

## 常见问题

### Q: 汉字显示为空白或乱码
A: 
- 确保选择了汉字库
- 检查字库文件是否存在于 `fonts/hzk2/` 目录
- 打开浏览器控制台查看错误信息

### Q: 部分汉字无法显示
A:
- 检查字符是否在GB2312编码范围内
- 某些生僻字可能不在GB2312字符集中
- 查看控制台的警告信息

### Q: ASCII字符和汉字高度不一致
A:
- 选择高度匹配的字体组合
- 例如：8x16 ASCII字体 + HZK16 汉字库
- 或使用"使用汉字库"选项统一使用汉字库

### Q: 字库文件加载失败
A:
- 确保字库文件路径正确
- 检查Web服务器配置，确保可以访问二进制文件
- 查看浏览器控制台的网络请求错误

## 性能优化

### 字库缓存
- 字库文件在首次加载后会缓存在内存中
- 切换字库时无需重新加载已加载的字库

### 按需加载
- 字库文件仅在首次使用时加载
- 减少初始页面加载时间

## 扩展开发

### 添加新的字库

1. 将字库文件放入 `fonts/hzk2/` 目录
2. 在 `hzk_fonts.js` 中注册字库：
```javascript
hzkFontManager.registerFont('HZK_NAME', width, height, 'fonts/hzk2/HZK_FILE');
```
3. 在 `index.html` 的汉字库下拉框中添加选项

### 支持其他编码

可以扩展 `gb2312_encoder.js` 来支持其他字符编码（如GBK、Big5等）：

1. 生成新的映射表
2. 修改编码器的 `encodeChar` 方法
3. 调整字库的偏移计算逻辑

## 参考资料

- GB2312标准：94个区，每区94个位
- 字库格式：参考 `fonts/hzk2/README.md`
- Python参考实现：`hzk_dump.py`

## 更新日志

### v1.0 (2025-10-31)
- 初始版本
- 支持GB2312编码
- 支持6种汉字字库(HZK12-HZK48)
- 支持ASCII和汉字混合文本
- 支持反显模式

